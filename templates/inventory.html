{% extends "base.html" %}

{% block controls %}
  <form class="filter-form" method="get" action="{{ url_for('inventory') }}" data-autosubmit>
    <label>
      Search SKU
      <input type="text" name="q" placeholder="e.g. 19.CS" value="{{ query }}" />
    </label>
    <label>
      Min Total
      <input type="number" name="min_total" min="0" step="1" value="{{ min_total }}" />
    </label>
    <label>
      Min Barn
      <input type="number" name="min_barn" min="0" step="1" value="{{ min_barn }}" />
    </label>
    <label>
      Min Warehouse
      <input type="number" name="min_warehouse" min="0" step="1" value="{{ min_warehouse }}" />
    </label>
    <label>
      Min Library
      <input type="number" name="min_library" min="0" step="1" value="{{ min_library }}" />
    </label>
    <label class="inline-check">
      <input type="checkbox" name="hide_zero" value="1" {% if hide_zero %}checked{% endif %} />
      Hide Zero
    </label>
    <div class="multi-select pool-filter-dropdown" data-dropdown data-no-autosubmit>
      <button type="button" class="ghost-btn" data-dropdown-trigger>Filter Pools</button>
      <div class="multi-select-menu" data-dropdown-menu>
        <div class="multi-select-options">
          <label>
            <input type="checkbox" name="pool_barn" value="1" {% if "barn" in pool_filters %}checked{% endif %} />
            Barn
          </label>
          <label>
            <input type="checkbox" name="pool_warehouse" value="1" {% if "warehouse" in pool_filters %}checked{% endif %} />
            Warehouse
          </label>
          <label>
            <input type="checkbox" name="pool_library" value="1" {% if "library" in pool_filters %}checked{% endif %} />
            Library
          </label>
        </div>
      </div>
    </div>
    <a class="ghost-btn" href="{{ url_for('inventory') }}">Reset</a>
  </form>
{% endblock %}

{% block content %}
  <section class="panel">
    <div class="panel-head">
      <h2>Inventory</h2>
      <p>Inventory snapshot pulled from WineDirect Inventory Service.</p>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>SKU</th>
            <th>Product Name</th>
            {% if show_barn %}<th>Barn</th>{% endif %}
            {% if show_warehouse %}<th>Warehouse</th>{% endif %}
            {% if show_library %}<th>Library</th>{% endif %}
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for row in inventory %}
            <tr>
              <td>{{ row['sku'] }}</td>
              <td>{{ row['name'] }}</td>
              {% if show_barn %}<td>{{ "%.0f"|format(row['barn']) }}</td>{% endif %}
              {% if show_warehouse %}<td>{{ "%.0f"|format(row['warehouse']) }}</td>{% endif %}
              {% if show_library %}<td>{{ "%.0f"|format(row['library']) }}</td>{% endif %}
              <td>{{ "%.0f"|format(row['total']) }}</td>
            </tr>
          {% else %}
            <tr>
              <td colspan="6">No inventory records found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const dropdown = document.querySelector(".pool-filter-dropdown[data-dropdown]");
    if (dropdown) {
      const trigger = dropdown.querySelector("[data-dropdown-trigger]");
      const menu = dropdown.querySelector("[data-dropdown-menu]");
      const form = dropdown.closest("form");

      trigger.addEventListener("click", (e) => {
        e.stopPropagation();
        menu.classList.toggle("open");
      });

      document.addEventListener("click", (event) => {
        if (!dropdown.contains(event.target) && menu.classList.contains("open")) {
          menu.classList.remove("open");
          if (form) form.requestSubmit();
        }
      });
    }
  })();
</script>
{% endblock %}
