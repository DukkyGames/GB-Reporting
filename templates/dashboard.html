{% extends "base.html" %}

{% block controls %}
  <form class="date-form" method="get" action="{{ url_for('dashboard') }}">
    <label>
      Range
      <select name="range">
        <option value="this_month" {% if range_key == "this_month" %}selected{% endif %}>This month</option>
        <option value="last_month" {% if range_key == "last_month" %}selected{% endif %}>Last month</option>
        <option value="last_3_months" {% if range_key == "last_3_months" %}selected{% endif %}>Last 3 months</option>
        <option value="last_12_months" {% if range_key == "last_12_months" %}selected{% endif %}>Last 12 months</option>
        <option value="ytd" {% if range_key == "ytd" %}selected{% endif %}>Year to date</option>
        <option value="custom" {% if range_key == "custom" %}selected{% endif %}>Custom</option>
      </select>
    </label>
    <label>
      Start
      <input type="date" name="start" value="{{ start_date }}" />
    </label>
    <label>
      End
      <input type="date" name="end" value="{{ end_date }}" />
    </label>
    <button type="submit" class="primary-btn">Update</button>
  </form>
{% endblock %}

{% block content %}
  {% if report.empty %}
    <section class="panel">
      <h2>No data available</h2>
      <p>Use the date selector above or run a cache refresh.</p>
    </section>
  {% else %}
    <section class="panel kpi-panel">
      <div class="panel-head">
        <h2>Financial Snapshot</h2>
        <p>Core KPIs generated from WineDirect orders</p>
      </div>
      <div class="kpi-grid">
        {% for label, value in report.kpis %}
          <div class="kpi-tile">
            <div>
              <div class="kpi-value">{{ value }}</div>
              <div class="kpi-label">{{ label }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>

    <section class="grid two-col">
      <div class="panel">
        <div class="panel-head">
          <h3>Monthly Net Sales</h3>
          <p>Trend of net sales across the year</p>
        </div>
        <img class="chart-img" src="data:image/png;base64,{{ report.charts.monthly_net_sales }}" alt="Monthly net sales" />
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Orders & Units</h3>
          <p>Orders (bars) and units (line) each month</p>
        </div>
        <img class="chart-img" src="data:image/png;base64,{{ report.charts.orders_units }}" alt="Orders and units" />
      </div>
    </section>

    <section class="grid three-col">
      <div class="panel">
        <div class="panel-head">
          <h3>Top Products by Revenue</h3>
        </div>
        <img class="chart-img" src="data:image/png;base64,{{ report.charts.top_products_revenue }}" alt="Top products by revenue" />
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Top Products by Units</h3>
        </div>
        <img class="chart-img" src="data:image/png;base64,{{ report.charts.top_products_units }}" alt="Top products by units" />
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Customer Mix</h3>
        </div>
        <img class="chart-img" src="data:image/png;base64,{{ report.charts.customer_mix }}" alt="Customer mix" />
      </div>
    </section>

    <section class="grid two-col">
      <div class="panel">
        <div class="panel-head">
          <h3>Sales by Channel</h3>
        </div>
        <img class="chart-img" src="data:image/png;base64,{{ report.charts.sales_by_channel }}" alt="Sales by channel" />
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Top States (Shipped Orders)</h3>
        </div>
        <img class="chart-img" src="data:image/png;base64,{{ report.charts.top_states }}" alt="Top states" />
      </div>
    </section>

    <section class="panel table-panel">
      <div class="panel-head">
        <h3>Monthly Summary</h3>
        <p>Net sales, orders, and units by month</p>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Month</th>
              <th>Net Sales</th>
              <th>Orders</th>
              <th>Units</th>
            </tr>
          </thead>
          <tbody>
            {% for row in report.table %}
              <tr>
                <td>{{ row.month }}</td>
                <td>{{ row.net_sales }}</td>
                <td>{{ row.orders }}</td>
                <td>{{ row.units }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  {% endif %}
{% endblock %}

{% block scripts %}{% endblock %}
