{% extends "base.html" %}

{% block content %}
  {% if report.empty %}
    <section class="panel">
      <h2>No data available</h2>
      <p>Use the date selector above or run a cache refresh.</p>
    </section>
  {% else %}
    <section class="panel kpi-panel">
      <div class="panel-head">
        <h2>Financial Snapshot</h2>
      </div>
      <div class="kpi-grid">
        {% set kpi_icons = {
          "Net Sales": "icons/Net Sales.png",
          "Product Net Sales": "icons/Net Sales.png",
          "Total Collected": "icons/Total Collected.png",
          "Total Collected (Wine + Tours)": "icons/Total Collected.png",
          "Orders": "icons/Orders.png",
          "Bottles Sold": "icons/Units Sold.png",
          "Cases Sold": "icons/Units Sold.png",
          "Avg Order Value": "icons/Avg order value.png",
          "Avg Bottle Price": "icons/Average Bottle Price.png",
          "Avg Case Price": "icons/Average Bottle Price.png",
          "Unique Customers": "icons/Unique Customers.png",
          "Repeat Rate": "icons/Repeat Rate.png",
          "Avg Bottles / Customer": "icons/Average bottles Cust.png",
          "Avg Cases / Customer": "icons/Average bottles Cust.png",
          "Shipped Orders": "icons/Shipped orders.png",
          "Pickup Orders": "icons/Pickup orders.png",
          "Taxes Collected": "icons/Taxes Collected.png",
          "Peak Month": "icons/Peak Month.png",
          "Best Day": "icons/Peak Month.png",
          "Lowest Month": "icons/Lowest month.png"
          ,
          "Lowest Day": "icons/Lowest month.png"
        } %}
        {% for label, value in report.kpis %}
          <div class="kpi-tile">
            {% set icon = kpi_icons.get(label) %}
            {% if icon %}
              <img class="kpi-icon" src="{{ url_for('static', filename=icon) }}" alt="" />
            {% endif %}
            <div class="kpi-meta">
              <div class="kpi-value">{{ value }}</div>
              <div class="kpi-label">{{ label }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>

    {% if tours_report and not tours_report.empty %}
      <section class="panel kpi-panel">
        <div class="panel-head">
          <h2>Tour Bookings Snapshot</h2>
        </div>
        <div class="kpi-grid">
          {% for label, value in tours_report.kpis %}
            {% if label in ["Bookings", "Guests", "Collected"] %}
              <div class="kpi-tile">
                <div class="kpi-meta">
                  <div class="kpi-value">{{ value }}</div>
                  <div class="kpi-label">{{ label }}</div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </section>

      <section class="grid two-col">
        <div class="panel">
          <div class="panel-head">
            <h3>Tour Bookings & Guests</h3>
            <p>{% if is_single_month %}Daily{% else %}Monthly{% endif %} bookings (bars) and guests (line)</p>
          </div>
          <div class="chart-plot" id="tours-dashboard-bookings"></div>
        </div>
        <div class="panel">
          <div class="panel-head">
            <h3>Tour Collected</h3>
            <p>{% if is_single_month %}Daily{% else %}Monthly{% endif %} collected revenue</p>
          </div>
          <div class="chart-plot" id="tours-dashboard-collected"></div>
        </div>
      </section>
    {% endif %}

    <section class="grid two-col">
      <div class="panel">
        <div class="panel-head">
          <h3>{% if is_single_month %}Daily{% else %}Monthly{% endif %} Net Sales</h3>
          <p>Trend of net sales{% if not is_single_month %} across the year{% endif %}</p>
        </div>
        <div class="chart-plot" id="chart-monthly-net-sales"></div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Orders & {{ unit_label }}</h3>
          <p>Orders (bars) and {{ unit_label|lower }} (line) each {% if is_single_month %}day{% else %}month{% endif %}</p>
        </div>
        <div class="chart-plot" id="chart-orders-units"></div>
      </div>
    </section>

    <section class="grid three-col">
      <div class="panel">
        <div class="panel-head">
          <h3>Top Products by Revenue</h3>
        </div>
        <div class="chart-plot" id="chart-top-products-revenue"></div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Top Products by Units</h3>
        </div>
        <div class="chart-plot" id="chart-top-products-units"></div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Customer Mix</h3>
        </div>
        <div class="chart-plot" id="chart-customer-mix"></div>
      </div>
    </section>

    <section class="grid two-col">
      <div class="panel">
        <div class="panel-head">
          <h3>Sales by Channel</h3>
        </div>
        <div class="chart-plot" id="chart-sales-by-channel"></div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Top States (Shipped Orders)</h3>
        </div>
        <div class="chart-plot" id="chart-top-states"></div>
      </div>
    </section>

    <section class="panel table-panel">
      <div class="panel-head">
        <h3>Monthly Summary</h3>
        <p>Net sales, orders, and units by month</p>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Month</th>
              <th>Net Sales</th>
              <th>Orders</th>
              <th>Units</th>
            </tr>
          </thead>
          <tbody>
            {% for row in report.table %}
              <tr>
                <td>{{ row.month }}</td>
                <td>{{ row.net_sales }}</td>
                <td>{{ row.orders }}</td>
                <td>{{ row.units }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  {% endif %}
{% endblock %}

{% block scripts %}
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script>
    (function () {
      const charts = {{ report.charts | tojson }};
      const isSingleMonth = {{ is_single_month | tojson }};
      const hasDailyLabels = (labels) =>
        (labels || []).some((label) => typeof label === "string" && label.includes(","));
      const chartBottomMargin = (labels) => (hasDailyLabels(labels) ? 120 : 50);
      const buildTicks = (labels) => {
        if (!labels || !labels.length) return {};
        const daily = hasDailyLabels(labels);
        return {
          tickmode: "array",
          tickvals: labels,
          ticktext: labels,
          tickangle: daily ? -60 : -35,
          tickfont: { size: daily ? 9 : 10 },
          ticklabelstandoff: 6,
          ticklabeloverflow: "allow",
          automargin: true,
        };
      };
      const toursCharts = {{ tours_report.charts | default({}) | tojson }};
      if (!charts) return;
      const monthLabels = charts.monthly.labels || [];
      const netSales = charts.monthly.net_sales || [];
      const orders = charts.monthly.orders || [];
      const units = charts.monthly.units || [];
      const unitLabel = "{{ unit_label }}";

      Plotly.newPlot(
        "chart-monthly-net-sales",
        [
          {
            x: monthLabels,
            y: netSales,
            type: "scatter",
            mode: "lines+markers",
            line: { color: "#0f8da0" },
            fill: "tozeroy",
            hovertemplate: "%{x}<br>$%{y:,.2f}<extra></extra>",
          },
        ],
        {
          margin: { t: 10, r: 10, b: chartBottomMargin(monthLabels), l: 50 },
          yaxis: { tickprefix: "$" },
          xaxis: buildTicks(monthLabels),
        },
        { displayModeBar: false, responsive: true }
      );

      Plotly.newPlot(
        "chart-orders-units",
        [
          {
            x: monthLabels,
            y: orders,
            type: "bar",
            name: "Orders",
            marker: { color: "#7dd3d6" },
            hovertemplate: "%{x}<br>%{y} orders<extra></extra>",
          },
          {
            x: monthLabels,
            y: units,
            type: "scatter",
            mode: "lines+markers",
            name: unitLabel,
            line: { color: "#f7b44a" },
            hovertemplate: `%{x}<br>%{y} ${unitLabel.toLowerCase()}<extra></extra>`,
          },
        ],
        {
          margin: { t: 10, r: 10, b: chartBottomMargin(monthLabels), l: 50 },
          barmode: "group",
          xaxis: buildTicks(monthLabels),
        },
        { displayModeBar: false, responsive: true }
      );

      const topRevenueValues = charts.top_products_revenue.values || [];
      const topRevenueLabels = charts.top_products_revenue.labels || [];
      const maxRevenue = topRevenueValues.length ? Math.max(...topRevenueValues) : 0;
      const revenuePad = maxRevenue > 0 ? maxRevenue * 0.08 : 1;

      Plotly.newPlot(
        "chart-top-products-revenue",
        [
          {
            x: topRevenueValues,
            y: topRevenueLabels,
            type: "bar",
            orientation: "h",
            marker: { color: "#5c8ef2" },
            hovertemplate: "%{y}<br>$%{x:,.2f}<extra></extra>",
          },
        ],
        {
          margin: { t: 10, r: 10, b: 30, l: 80 },
          xaxis: { tickprefix: "$", range: [-revenuePad, maxRevenue * 1.02], zeroline: false },
          yaxis: { autorange: "reversed" },
        },
        { displayModeBar: false, responsive: true }
      );

      const topUnitsValues = charts.top_products_units.values || [];
      const topUnitsLabels = charts.top_products_units.labels || [];
      const maxUnits = topUnitsValues.length ? Math.max(...topUnitsValues) : 0;
      const unitsPad = maxUnits > 0 ? maxUnits * 0.05 : 1;

      Plotly.newPlot(
        "chart-top-products-units",
        [
          {
            x: topUnitsValues,
            y: topUnitsLabels,
            type: "bar",
            orientation: "h",
            marker: { color: "#0b6c7c" },
            hovertemplate: "%{y}<br>%{x} units<extra></extra>",
          },
        ],
        {
          margin: { t: 10, r: 10, b: 30, l: 80 },
          xaxis: { range: [-unitsPad, maxUnits * 1.02], zeroline: false },
          yaxis: { autorange: "reversed" },
        },
        { displayModeBar: false, responsive: true }
      );

      Plotly.newPlot(
        "chart-customer-mix",
        [
          {
            labels: charts.customer_mix.labels || [],
            values: charts.customer_mix.values || [],
            type: "pie",
            marker: { colors: ["#0f8da0", "#7dd3d6"] },
            textinfo: "label+percent",
            hovertemplate: "%{label}: %{value}<extra></extra>",
          },
        ],
        {
          margin: { t: 10, r: 10, b: 10, l: 10 },
        },
        { displayModeBar: false, responsive: true }
      );

      Plotly.newPlot(
        "chart-sales-by-channel",
        [
          {
            x: charts.sales_by_channel.labels || [],
            y: charts.sales_by_channel.values || [],
            type: "bar",
            marker: { color: "#0f8da0" },
            hovertemplate: "%{x}<br>$%{y:,.2f}<extra></extra>",
          },
        ],
        {
          margin: { t: 10, r: 10, b: chartBottomMargin(charts.sales_by_channel.labels || []), l: 50 },
          yaxis: { tickprefix: "$" },
          xaxis: buildTicks(charts.sales_by_channel.labels || []),
        },
        { displayModeBar: false, responsive: true }
      );

      Plotly.newPlot(
        "chart-top-states",
        [
          {
            x: charts.top_states.labels || [],
            y: charts.top_states.values || [],
            type: "bar",
            marker: { color: "#0b6c7c" },
            hovertemplate: "%{x}<br>$%{y:,.2f}<extra></extra>",
          },
        ],
        {
          margin: { t: 10, r: 10, b: chartBottomMargin(charts.top_states.labels || []), l: 50 },
          yaxis: { tickprefix: "$" },
          xaxis: buildTicks(charts.top_states.labels || []),
        },
        { displayModeBar: false, responsive: true }
      );

      if (toursCharts && toursCharts.monthly) {
        Plotly.newPlot(
          "tours-dashboard-bookings",
          [
            {
              x: toursCharts.monthly.labels || [],
              y: toursCharts.monthly.bookings || [],
              type: "bar",
              name: "Bookings",
              marker: { color: "#0f8da0" },
            },
            {
              x: toursCharts.monthly.labels || [],
              y: toursCharts.monthly.guests || [],
              type: "scatter",
              mode: "lines+markers",
              name: "Guests",
              line: { color: "#f7b44a" },
            },
          ],
          {
            margin: { t: 10, r: 10, b: chartBottomMargin(toursCharts.monthly.labels || []), l: 50 },
            barmode: "group",
            xaxis: buildTicks(toursCharts.monthly.labels || []),
          },
          { displayModeBar: false, responsive: true }
        );

        Plotly.newPlot(
          "tours-dashboard-collected",
          [
            {
              x: toursCharts.monthly.labels || [],
              y: toursCharts.monthly.collected || [],
              type: "bar",
              marker: { color: "#5c8ef2" },
              hovertemplate: "%{x}<br>$%{y:,.2f}<extra></extra>",
            },
          ],
          {
            margin: { t: 10, r: 10, b: chartBottomMargin(toursCharts.monthly.labels || []), l: 50 },
            yaxis: { tickprefix: "$" },
            xaxis: buildTicks(toursCharts.monthly.labels || []),
          },
          { displayModeBar: false, responsive: true }
        );
      }
    })();
  </script>
{% endblock %}
