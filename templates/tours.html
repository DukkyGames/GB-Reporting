{% extends "base.html" %}

{% block controls %}
  <form class="filter-form" method="get" action="{{ url_for('tours') }}">
    <input type="hidden" name="range" value="{{ range_key }}" />
    <input type="hidden" name="start" value="{{ start_date }}" />
    <input type="hidden" name="end" value="{{ end_date }}" />
    <input type="hidden" name="experiences" id="experience-filter" value="{{ selected_experiences|join(',') }}" />
    <div class="multi-select" data-dropdown>
      <button type="button" class="ghost-btn" data-dropdown-trigger>
        Filter Experiences
      </button>
      <div class="multi-select-menu" data-dropdown-menu>
        <label class="multi-select-all">
          <input type="checkbox" data-select-all />
          All Experiences
        </label>
        <div class="multi-select-options">
          {% for option in experience_options %}
            <label>
              <input type="checkbox" value="{{ option }}" {% if option in selected_experiences %}checked{% endif %} />
              {{ option }}
            </label>
          {% endfor %}
        </div>
      </div>
    </div>
  </form>
{% endblock %}

{% block content %}
  {% if report.empty %}
    <section class="panel">
      <h2>No tour bookings data</h2>
      <p>Upload a Tock transactions CSV to get started.</p>
    </section>
  {% else %}
    <section class="panel kpi-panel">
      <div class="panel-head">
        <h2>Tour Booking KPIs</h2>
        <p>Summary of bookings for the selected date range</p>
      </div>
      <div class="kpi-grid">
        {% for label, value in report.kpis %}
          <div class="kpi-tile">
            <div class="kpi-meta">
              <div class="kpi-value">{{ value }}</div>
              <div class="kpi-label">{{ label }}</div>
              {% if label == "Avg Revenue / Guest" %}
                <div class="kpi-subtitle">Tours + matched orders</div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </section>

    <section class="grid two-col">
      <div class="panel">
        <div class="panel-head">
          <h3>Bookings Over Time</h3>
          <p>Monthly bookings and guests</p>
        </div>
        <div class="chart-plot" id="tours-monthly"></div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Revenue Over Time</h3>
          <p>Monthly gross sales</p>
        </div>
        <div class="chart-plot" id="tours-sales"></div>
      </div>
    </section>

    <section class="grid two-col">
      <div class="panel">
        <div class="panel-head">
          <h3>Top Experiences (Bookings)</h3>
        </div>
        <div class="chart-plot" id="tours-experiences"></div>
      </div>
      <div class="panel">
        <div class="panel-head">
          <h3>Top Experiences (Revenue)</h3>
        </div>
        <div class="chart-plot" id="tours-experience-sales"></div>
      </div>
    </section>

    <section class="panel table-panel">
      <div class="panel-head">
        <h3>Latest Bookings</h3>
        <p>Showing up to 200 bookings from the current range</p>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Customer</th>
              <th>Experience</th>
              <th>Party Size</th>
              <th>Total Price</th>
              <th>Collected</th>
              <th>Orders</th>
            </tr>
          </thead>
          <tbody>
            {% for row in report.table %}
              <tr>
                <td>{{ row.booking_date }}</td>
                <td>{{ row.customer }}</td>
                <td>{{ row.experience }}</td>
                <td>{{ row.party_size }}</td>
                <td>${{ "%.2f"|format(row.total_price) }}</td>
                <td>${{ "%.2f"|format(row.payment_collected) }}</td>
                <td>
                  {% if row.has_orders %}
                    <a class="ghost-btn" href="{{ url_for('orders_by_email', email=row.email, unit=unit) }}">Show Orders</a>
                  {% else %}
                    <span class="ghost-btn is-disabled">Show Orders</span>
                  {% endif %}
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="7">No bookings for this range.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script>
    (function () {
      const dropdown = document.querySelector("[data-dropdown]");
      if (dropdown) {
        const trigger = dropdown.querySelector("[data-dropdown-trigger]");
        const menu = dropdown.querySelector("[data-dropdown-menu]");
        const form = dropdown.closest("form");
        const hidden = document.getElementById("experience-filter");
        const checkboxes = Array.from(menu.querySelectorAll("input[type='checkbox']")).filter((el) => !el.hasAttribute("data-select-all"));
        const selectAll = menu.querySelector("[data-select-all]");

        const syncHidden = () => {
          const values = checkboxes.filter((cb) => cb.checked).map((cb) => cb.value);
          hidden.value = values.join(",");
          if (selectAll) {
            selectAll.checked = values.length === checkboxes.length;
          }
        };

        if (selectAll) {
          selectAll.addEventListener("change", () => {
            const checked = selectAll.checked;
            checkboxes.forEach((cb) => {
              cb.checked = checked;
            });
            syncHidden();
          });
        }

        checkboxes.forEach((cb) => {
          cb.addEventListener("change", syncHidden);
        });

        trigger.addEventListener("click", () => {
          menu.classList.toggle("open");
        });

        document.addEventListener("click", (event) => {
          if (!dropdown.contains(event.target) && menu.classList.contains("open")) {
            menu.classList.remove("open");
            if (form) {
              form.requestSubmit();
            }
          }
        });

        syncHidden();
      }

      const charts = {{ report.charts | default({}) | tojson }};
      const hasDailyLabels = (labels) =>
        (labels || []).some((label) => typeof label === "string" && label.includes(","));
      const chartBottomMargin = (labels) => (hasDailyLabels(labels) ? 120 : 50);
      const buildTicks = (labels) => {
        if (!labels || !labels.length) return {};
        const daily = hasDailyLabels(labels);
        return {
          tickmode: "array",
          tickvals: labels,
          ticktext: labels,
          tickangle: daily ? -60 : -35,
          tickfont: { size: daily ? 9 : 10 },
          ticklabelstandoff: 6,
          ticklabeloverflow: "allow",
          automargin: true,
        };
      };
      if (!charts || !charts.monthly) return;
      const fullExperienceLabels = charts.experiences?.labels || [];
      const truncateLabel = (label, maxLen = 28) => {
        if (!label) return "";
        if (label.length <= maxLen) return label;
        return label.slice(0, Math.max(0, maxLen - 1)) + "...";
      };
      const shortExperienceLabels = fullExperienceLabels.map((label) => truncateLabel(label));

      Plotly.newPlot(
        "tours-monthly",
        [
          {
            x: charts.monthly.labels || [],
            y: charts.monthly.bookings || [],
            type: "bar",
            name: "Bookings",
            marker: { color: "#0f8da0" },
          },
          {
            x: charts.monthly.labels || [],
            y: charts.monthly.guests || [],
            type: "scatter",
            mode: "lines+markers",
            name: "Guests",
            line: { color: "#f7b44a" },
          },
        ],
        {
          margin: { t: 10, r: 10, b: chartBottomMargin(charts.monthly.labels || []), l: 50 },
          barmode: "group",
          xaxis: buildTicks(charts.monthly.labels || []),
        },
        { displayModeBar: false, responsive: true }
      );

      Plotly.newPlot(
        "tours-sales",
        [
          {
            x: charts.monthly.labels || [],
            y: charts.monthly.sales || [],
            type: "bar",
            marker: { color: "#5c8ef2" },
            hovertemplate: "%{x}<br>$%{y:,.2f}<extra></extra>",
          },
        ],
        {
          margin: { t: 10, r: 10, b: chartBottomMargin(charts.monthly.labels || []), l: 50 },
          yaxis: { tickprefix: "$" },
          xaxis: buildTicks(charts.monthly.labels || []),
        },
        { displayModeBar: false, responsive: true }
      );

      Plotly.newPlot(
        "tours-experiences",
        [
          {
            x: charts.experiences.bookings || [],
            y: shortExperienceLabels,
            type: "bar",
            orientation: "h",
            marker: { color: "#0b6c7c" },
            customdata: fullExperienceLabels,
            hovertemplate: "%{customdata}<br>%{x} bookings<extra></extra>",
          },
        ],
        {
          margin: { t: 10, r: 10, b: 30, l: 180 },
          yaxis: { autorange: "reversed", automargin: true },
        },
        { displayModeBar: false, responsive: true }
      );

      Plotly.newPlot(
        "tours-experience-sales",
        [
          {
            x: charts.experiences.sales || [],
            y: shortExperienceLabels,
            type: "bar",
            orientation: "h",
            marker: { color: "#7dd3d6" },
            customdata: fullExperienceLabels,
            hovertemplate: "%{customdata}<br>$%{x:,.2f}<extra></extra>",
          },
        ],
        {
          margin: { t: 10, r: 10, b: 30, l: 180 },
          xaxis: { tickprefix: "$" },
          yaxis: { autorange: "reversed", automargin: true },
        },
        { displayModeBar: false, responsive: true }
      );
    })();
  </script>
{% endblock %}

