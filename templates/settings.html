{% extends "base.html" %}

{% block controls %}
  <form class="filter-form" method="post" action="{{ url_for('tours_upload') }}" enctype="multipart/form-data">
    <label>
      Upload Tock CSV
      <input type="file" name="tock_csv" accept=".csv" required />
    </label>
    <label class="inline-check">
      <input type="checkbox" name="replace_existing" value="1" />
      Replace existing data
    </label>
    <button type="submit" class="primary-btn">Import CSV</button>
  </form>
{% endblock %}

{% block content %}
  <section class="panel control-panel">
    <div class="control-group">
      <form method="post" action="{{ url_for('refresh_orders') }}" class="inline-form" data-confirm="This will clear all orders and reload from WineDirect. Continue?">
        <button type="submit" class="primary-btn">Refresh Orders</button>
      </form>
      <form method="post" action="{{ url_for('refresh_products') }}" class="inline-form" data-confirm="This will clear all products and reload from WineDirect. Continue?">
        <button type="submit" class="primary-btn">Refresh Products</button>
      </form>
      <form method="post" action="{{ url_for('refresh_inventory') }}" class="inline-form" data-confirm="This will clear all inventory and reload from WineDirect. Continue?">
        <button type="submit" class="primary-btn">Refresh Inventory</button>
      </form>
      <form method="post" action="{{ url_for('refresh_latest') }}" class="inline-form">
        <button type="submit" class="primary-btn">Update Latest Data</button>
      </form>
      <form method="post" action="{{ url_for('rate_check') }}" class="inline-form">
        <button type="submit" class="primary-btn">Rate Check</button>
      </form>
    </div>
  </section>

  <section class="panel status-panel">
    <div class="panel-head">
      <h2>Cache Status</h2>
      <p>Track refresh progress and cached totals.</p>
    </div>
    <div class="status-grid">
      <div class="status-item">
        <span class="status-label">Refresh State</span>
        <span class="status-value" data-cache-status="state">
          {% if cache_status.in_progress %}In progress{% else %}Idle{% endif %}
        </span>
      </div>
      <div class="status-item">
        <span class="status-label">Last Result</span>
        <span class="status-value" data-cache-status="result">{{ cache_status.result }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Last Started</span>
        <span class="status-value" data-cache-status="started_at">{{ cache_status.started_at }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Last Finished</span>
        <span class="status-value" data-cache-status="finished_at">{{ cache_status.finished_at }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Latest Order Date</span>
        <span class="status-value" data-cache-status="latest_order_date">{{ cache_status.latest_order_date or "—" }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Orders Cached</span>
        <span class="status-value" data-cache-status="orders_count">{{ cache_status.orders_count }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Items Cached</span>
        <span class="status-value" data-cache-status="items_count">{{ cache_status.items_count }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Products Cached</span>
        <span class="status-value" data-cache-status="products_count">{{ cache_status.products_count }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Inventory Rows</span>
        <span class="status-value" data-cache-status="inventory_count">{{ cache_status.inventory_count }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Rate Limit</span>
        <span class="status-value" data-cache-status="rate_limit_limit">{{ cache_status.rate_limit_limit }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Rate Limit Remaining</span>
        <span class="status-value" data-cache-status="rate_limit_remaining">{{ cache_status.rate_limit_remaining }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Rate Limit Reset</span>
        <span class="status-value" data-cache-status="rate_limit_reset_at">{{ cache_status.rate_limit_reset_at }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Refresh Page</span>
        <span class="status-value" data-cache-status="refresh_page">{{ cache_status.refresh_page }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Orders Fetched</span>
        <span class="status-value" data-cache-status="refresh_fetched">{{ cache_status.refresh_fetched }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Total Orders</span>
        <span class="status-value" data-cache-status="refresh_total">{{ cache_status.refresh_total }}</span>
      </div>
      <div class="status-item status-progress">
        <span class="status-label">Progress</span>
        <div class="progress-bar">
          <div class="progress-fill" data-cache-status="refresh_progress"></div>
        </div>
        <span class="status-value" data-cache-status="refresh_progress_label">—</span>
      </div>
      {% if cache_status.last_error %}
        <div class="status-item status-error" data-cache-status="error_block">
          <span class="status-label">Last Error</span>
          <span class="status-value" data-cache-status="last_error">{{ cache_status.last_error }}</span>
        </div>
      {% endif %}
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
  document.querySelectorAll("form[data-confirm]").forEach((form) => {
    form.addEventListener("submit", (event) => {
      const message = form.getAttribute("data-confirm") || "Are you sure?";
      if (!window.confirm(message)) {
        event.preventDefault();
      }
    });
  });

  const statusFields = document.querySelectorAll("[data-cache-status]");
  const statusMap = {};
  for (const field of statusFields) {
    const key = field.getAttribute("data-cache-status");
    if (!statusMap[key]) {
      statusMap[key] = [];
    }
    statusMap[key].push(field);
  }

  async function refreshCacheStatus() {
    try {
      const response = await fetch("{{ url_for('cache_status') }}", { cache: "no-store" });
      if (!response.ok) {
        return;
      }
      const data = await response.json();
      const stateText = data.in_progress ? "In progress" : "Idle";
      const updates = {
        state: stateText,
        result: data.result || "—",
        started_at: data.started_at || "—",
        finished_at: data.finished_at || "—",
        latest_order_date: data.latest_order_date || "—",
        orders_count: data.orders_count || "0",
        items_count: data.items_count || "0",
        products_count: data.products_count || "0",
        inventory_count: data.inventory_count || "0",
        rate_limit_limit: data.rate_limit_limit || "—",
        rate_limit_remaining: data.rate_limit_remaining || "—",
        rate_limit_reset_at: data.rate_limit_reset_at || "—",
        refresh_page: data.refresh_page || "0",
        refresh_fetched: data.refresh_fetched || "0",
        refresh_total: data.refresh_total || "0",
        last_error: data.last_error || ""
      };

      for (const [key, value] of Object.entries(updates)) {
        if (!statusMap[key]) {
          continue;
        }
        for (const node of statusMap[key]) {
          node.textContent = value;
        }
      }

      const fetched = Number.parseInt(data.refresh_fetched || "0", 10);
      const total = Number.parseInt(data.refresh_total || "0", 10);
      if (statusMap.refresh_progress) {
        const fill = statusMap.refresh_progress[0];
        if (total > 0) {
          const pct = Math.min(Math.round((fetched / total) * 100), 100);
          fill.style.width = `${pct}%`;
          if (statusMap.refresh_progress_label) {
            for (const node of statusMap.refresh_progress_label) {
              node.textContent = `${pct}%`;
            }
          }
        } else {
          fill.style.width = fetched > 0 ? "30%" : "0%";
          if (statusMap.refresh_progress_label) {
            for (const node of statusMap.refresh_progress_label) {
              node.textContent = fetched > 0 ? `${fetched} fetched` : "—";
            }
          }
        }
      }

      if (data.last_error) {
        if (!statusMap.error_block) {
          const grid = document.querySelector(".status-grid");
          if (grid) {
            const errorDiv = document.createElement("div");
            errorDiv.className = "status-item status-error";
            errorDiv.setAttribute("data-cache-status", "error_block");
            errorDiv.innerHTML = `
              <span class="status-label">Last Error</span>
              <span class="status-value" data-cache-status="last_error"></span>
            `;
            grid.appendChild(errorDiv);
            statusMap.error_block = [errorDiv];
            statusMap.last_error = Array.from(errorDiv.querySelectorAll("[data-cache-status='last_error']"));
            for (const node of statusMap.last_error) {
              node.textContent = data.last_error;
            }
          }
        }
      }
    } catch (err) {
      // Silent fail to avoid UI noise on transient network issues.
    }
  }

  refreshCacheStatus();
  setInterval(refreshCacheStatus, 15000);
</script>
{% endblock %}
