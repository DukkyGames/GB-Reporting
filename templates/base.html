<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grimm's Bluff Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='Logo.png') }}" />
</head>
<body>
  {% set current_range = range_key|default(request.args.get("range", "custom")) %}
  {% set current_start = start_date|default(request.args.get("start", "")) %}
  {% set current_end = end_date|default(request.args.get("end", "")) %}
  {% set preserve_skip = preserve_skip|default([]) %}
  {% if request.endpoint == "inventory" %}
    {% set current_unit = request.args.get("unit", "bottle") %}
  {% else %}
    {% set current_unit = request.args.get("unit", "case") %}
  {% endif %}
  <header class="topbar">
    <div class="brand">
      <a class="brand-link" href="{{ url_for('dashboard') }}">
        <div class="brand-mark">
          <img src="{{ url_for('static', filename='Logo.png') }}" alt="Grimm's Bluff logo" />
        </div>
        <div>
          <h1>Grimm's Bluff Dashboard</h1>
          <p>Because WineDirect sucks</p>
        </div>
      </a>
    </div>
    <div class="controls">
      <a class="ghost-btn" href="{{ url_for('dashboard', range=current_range, start=current_start, end=current_end) }}">Dashboard</a>
      <a class="ghost-btn" href="{{ url_for('orders', range=current_range, start=current_start, end=current_end) }}">Orders</a>
      <a class="ghost-btn" href="{{ url_for('products_report', range=current_range, start=current_start, end=current_end) }}">Products Report</a>
      <a class="ghost-btn" href="{{ url_for('inventory', range=current_range, start=current_start, end=current_end) }}">Inventory</a>
      <a class="ghost-btn" href="{{ url_for('tours', range=current_range, start=current_start, end=current_end) }}">Tours</a>
      <a class="ghost-btn" href="{{ url_for('settings', range=current_range, start=current_start, end=current_end) }}">Settings</a>
      <a class="ghost-btn" href="{{ url_for('logout') }}">Log out</a>
    </div>
    <form class="date-form" method="get" action="{{ request.path }}" data-autosubmit>
      <label>
        Range
        <select name="range">
          <option value="this_month" {% if current_range == "this_month" %}selected{% endif %}>This month</option>
          <option value="last_month" {% if current_range == "last_month" %}selected{% endif %}>Last month</option>
          <option value="last_year" {% if current_range == "last_year" %}selected{% endif %}>Last year</option>
          <option value="last_3_months" {% if current_range == "last_3_months" %}selected{% endif %}>Last 3 months</option>
          <option value="last_12_months" {% if current_range == "last_12_months" %}selected{% endif %}>Last 12 months</option>
          <option value="ytd" {% if current_range == "ytd" %}selected{% endif %}>Year to date</option>
          <option value="custom" {% if current_range == "custom" %}selected{% endif %}>Custom</option>
        </select>
      </label>
      <label>
        Start
        <input type="date" name="start" value="{{ current_start }}" />
      </label>
      <label>
        End
        <input type="date" name="end" value="{{ current_end }}" />
      </label>
      <label class="inline-check">
        <input type="radio" name="unit" value="case" {% if current_unit == "case" %}checked{% endif %} />
        Cases
      </label>
      <label class="inline-check">
        <input type="radio" name="unit" value="bottle" {% if current_unit != "case" %}checked{% endif %} />
        Bottles
      </label>
      {% for key, value in request.args.items() %}
        {% if key not in ["range", "start", "end", "unit"] and key not in preserve_skip %}
          <input type="hidden" name="{{ key }}" value="{{ value }}" />
        {% endif %}
      {% endfor %}
    </form>
    {% if export_excel_url or export_pdf_url %}
      <div class="export-actions">
        {% if export_excel_url %}
          <a class="ghost-btn" href="{{ export_excel_url }}">Export Excel</a>
        {% endif %}
        {% if export_pdf_url %}
          <a class="ghost-btn" href="{{ export_pdf_url }}">Export PDF</a>
        {% endif %}
      </div>
    {% endif %}
  </header>

  <main class="page">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-wrap">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    <section class="panel controls-panel">
      <div class="controls-panel-head">
      </div>
      <div class="controls-panel-body">
        {% block controls %}{% endblock %}
      </div>
    </section>
    {% block content %}{% endblock %}
  </main>

  <footer class="footer">
    <span>Grimm's Bluff Reporting</span>
    <span>Powered by Grimmedia</span>
  </footer>

  <script>
    function getCellValue(row, idx) {
      const cell = row.children[idx];
      return cell ? cell.textContent.trim() : "";
    }

    function parseValue(value) {
      const cleaned = value.replace(/[$,%]/g, "").replace(/\s+/g, " ").trim();
      const num = Number(cleaned);
      if (!Number.isNaN(num) && cleaned !== "") {
        return num;
      }
      return value.toLowerCase();
    }

    function sortTable(table, idx, asc) {
      const tbody = table.tBodies[0];
      if (!tbody) return;
      const rows = Array.from(tbody.rows).filter((row) => !row.classList.contains("total-row"));
      const totalRows = Array.from(tbody.rows).filter((row) => row.classList.contains("total-row"));
      rows.sort((a, b) => {
        const aVal = parseValue(getCellValue(a, idx));
        const bVal = parseValue(getCellValue(b, idx));
        if (aVal < bVal) return asc ? -1 : 1;
        if (aVal > bVal) return asc ? 1 : -1;
        return 0;
      });
      rows.forEach((row) => tbody.appendChild(row));
      totalRows.forEach((row) => tbody.appendChild(row));
    }

    function initSortableTables() {
      document.querySelectorAll("table").forEach((table) => {
        const headers = table.tHead ? Array.from(table.tHead.rows[0].cells) : [];
        headers.forEach((th, idx) => {
          th.classList.add("sortable");
          th.addEventListener("click", () => {
            const asc = th.getAttribute("data-sort") !== "asc";
            headers.forEach((h) => h.removeAttribute("data-sort"));
            th.setAttribute("data-sort", asc ? "asc" : "desc");
            sortTable(table, idx, asc);
          });
        });
      });
    }

    function initAutoSubmitForms() {
      document.querySelectorAll("form[data-autosubmit]").forEach((form) => {
        const storageKey = `filters:${window.location.pathname}`;
        let timer = null;

        const loadSaved = () => {
          if (window.location.search) {
            return;
          }
          const raw = window.localStorage.getItem(storageKey);
          if (!raw) return;
          try {
            const data = JSON.parse(raw);
            form.querySelectorAll("input, select").forEach((field) => {
              if (!(field.name in data)) return;
              if (field.type === "checkbox") {
                field.checked = Boolean(data[field.name]);
              } else if (field.type === "radio") {
                field.checked = String(data[field.name]) === field.value;
              } else {
                field.value = data[field.name];
              }
            });
          } catch (err) {
            // Ignore malformed stored data.
          }
        };

        const saveCurrent = () => {
          const payload = {};
          form.querySelectorAll("input, select").forEach((field) => {
            if (!field.name) return;
            if (field.type === "checkbox") {
              payload[field.name] = field.checked;
            } else if (field.type === "radio") {
              if (field.checked) {
                payload[field.name] = field.value;
              }
            } else {
              payload[field.name] = field.value;
            }
          });
          window.localStorage.setItem(storageKey, JSON.stringify(payload));
        };

        const submitForm = () => {
          if (timer) {
            clearTimeout(timer);
          }
          saveCurrent();
          form.requestSubmit();
        };

        loadSaved();
        form.querySelectorAll("input, select").forEach((field) => {
          field.addEventListener("change", submitForm);
          field.addEventListener("input", () => {
            if (timer) {
              clearTimeout(timer);
            }
            timer = setTimeout(() => {
              saveCurrent();
              form.requestSubmit();
            }, 400);
          });
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initSortableTables();
      initAutoSubmitForms();
    });
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
